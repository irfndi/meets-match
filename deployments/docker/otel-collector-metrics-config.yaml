receivers:
  prometheus:
    config:
      scrape_configs:
        - job_name: 'signoz-metrics'
          scrape_interval: 15s
          static_configs:
            - targets: ['otel-collector:8889']
        
        - job_name: 'clickhouse'
          scrape_interval: 30s
          static_configs:
            - targets: ['clickhouse:8123']
          metrics_path: '/metrics'
        
        - job_name: 'query-service'
          scrape_interval: 30s
          static_configs:
            - targets: ['query-service:8080']
          metrics_path: '/metrics'
        
        - job_name: 'alertmanager'
          scrape_interval: 30s
          static_configs:
            - targets: ['alertmanager:9093']
          metrics_path: '/metrics'

  hostmetrics:
    collection_interval: 30s
    scrapers:
      cpu:
        metrics:
          system.cpu.utilization:
            enabled: true
      disk:
      filesystem:
        exclude_mount_points:
          mount_points: ["/dev/*", "/proc/*", "/sys/*", "/var/lib/docker/*", "/var/lib/containerd/*", "/snap/*"]
          match_type: regexp
        exclude_fs_types:
          fs_types: ["autofs", "binfmt_misc", "bpf", "cgroup2", "configfs", "debugfs", "devpts", "devtmpfs", "fusectl", "hugetlbfs", "iso9660", "mqueue", "nsfs", "overlay", "proc", "procfs", "pstore", "rpc_pipefs", "securityfs", "selinuxfs", "squashfs", "sysfs", "tracefs"]
          match_type: strict
      load:
      memory:
      network:
      paging:
      processes:
      process:
        mute_process_name_error: true
        mute_process_exe_error: true
        mute_process_io_error: true

  docker_stats:
    endpoint: unix:///var/run/docker.sock
    collection_interval: 30s
    timeout: 20s
    api_version: 1.24
    container_labels_to_metric_labels:
      container.image.name: image
      container.name: name
    env_vars_to_metric_labels:
      - ENVIRONMENT
      - SERVICE_NAME

processors:
  batch:
    timeout: 1s
    send_batch_size: 1024
    send_batch_max_size: 2048

  memory_limiter:
    limit_mib: 256
    spike_limit_mib: 64
    check_interval: 5s

  resource:
    attributes:
      - key: service.namespace
        value: "meets-match"
        action: upsert
      - key: deployment.environment
        value: "development"
        action: upsert
      - key: host.name
        from_attribute: host.name
        action: upsert

  resourcedetection:
    detectors: [env, system, docker]
    timeout: 5s
    override: false
    system:
      hostname_sources: ["os"]
      resource_attributes:
        host.name:
          enabled: true
        host.id:
          enabled: false
        os.description:
          enabled: true
        os.type:
          enabled: true

  # Transform processor for metric normalization
  transform:
    metric_statements:
      - context: metric
        statements:
          - set(description, "CPU usage percentage") where name == "system.cpu.utilization"
          - set(description, "Memory usage in bytes") where name == "system.memory.usage"
          - set(description, "Disk usage in bytes") where name == "system.filesystem.usage"
          - set(description, "Network bytes received") where name == "system.network.io"

exporters:
  # ClickHouse exporter for metrics
  clickhousemetricswrite:
    endpoint: tcp://clickhouse:9000?dial_timeout=10s&compress=lz4
    database: signoz_metrics
    username: signoz
    password: signoz
    timeout: 5s
    retry_on_failure:
      enabled: true
      initial_interval: 5s
      max_interval: 30s
      max_elapsed_time: 300s
    resource_to_telemetry_conversion:
      enabled: true

  # Prometheus exporter for real-time metrics
  prometheus:
    endpoint: "0.0.0.0:8888"
    const_labels:
      cluster: meets-match-local
      environment: development
    namespace: meets_match
    send_timestamps: true
    metric_expiration: 180m
    enable_open_metrics: true
    resource_to_telemetry_conversion:
      enabled: true

  # Debug exporter for troubleshooting
  debug:
    verbosity: normal
    sampling_initial: 2
    sampling_thereafter: 100

extensions:
  health_check:
    endpoint: 0.0.0.0:13133
  
  pprof:
    endpoint: 0.0.0.0:1777

service:
  extensions: [health_check, pprof]
  pipelines:
    metrics:
      receivers: [prometheus, hostmetrics, docker_stats]
      processors: [memory_limiter, resourcedetection, resource, transform, batch]
      exporters: [clickhousemetricswrite, prometheus]
  
  telemetry:
    logs:
      level: info
    metrics:
      address: 0.0.0.0:8888
      level: detailed