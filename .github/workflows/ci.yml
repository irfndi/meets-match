name: CI

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Bun
      uses: oven-sh/setup-bun@v1

    - name: Install dependencies
      run: bun install --frozen-lockfile

    - name: Lint with Biome
      run: bunx biome check .

    - name: Check Formatting with Biome
      run: bunx biome format --check .

    - name: Configure environment for tests
      run: |
        echo "# Test environment for CI" > .env.test
        echo "ENVIRONMENT=test" >> .env.test
        echo "LOG_LEVEL=DEBUG" >> .env.test
        echo "MATCH_THRESHOLD=0.75" >> .env.test

        echo "TELEGRAM_TOKEN=mock_token_for_ci_tests" >> .env.test

        echo "Test environment configuration:"
        cat .env.test | grep -v TOKEN

        cp .env.test .env

    - name: Run tests with coverage
      env:
        TELEGRAM_TOKEN: ${{ secrets.BOT_TOKEN || 'mock_token_for_ci_tests' }}
      run: |
        echo "Running tests with coverage..."
        bun test --coverage
        echo "Test run finished."

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./coverage/lcov.info
        flags: unittests
        verbose: true
        name: codecov-umbrella
        fail_ci_if_error: true

  deploy:
    runs-on: ubuntu-latest
    needs: test # Depends on the test job matrix completing successfully
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' # Only run on push to main branch

    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18' # Use a compatible Node.js version for wrangler

    - name: Install Wrangler
      run: npm install -g wrangler

    - name: Deploy to Cloudflare Workers
      env:
        CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
      run: wrangler deploy
